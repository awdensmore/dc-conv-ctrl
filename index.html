<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Dc-conv-ctrl by awdensmore</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Dc-conv-ctrl</h1>
      <h2 class="project-tagline">Control a Dc/DC converter using STM32.</h2>
      <a href="https://github.com/awdensmore/dc-conv-ctrl" class="btn">View on GitHub</a>
      <a href="https://github.com/awdensmore/dc-conv-ctrl/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/awdensmore/dc-conv-ctrl/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h3>
<a id="purpose" class="anchor" href="#purpose" aria-hidden="true"><span class="octicon octicon-link"></span></a>Purpose</h3>

<p>The aim of the project is to characterize the behavior of VRLA batteries so that online estimates of state of charge (SoC) and state of health (SoH) can be made using simple measurements: voltage, current, temperature and impedance. To do so, this repo is a hardware/software project to implement an aging process during which the data is collected. After collection, it is processed using a machine learning technique to build a data-driven model of the battery behavior.</p>

<p>This project is the work of the Power Electronics Research Group at the <a href="http://www.ee.uct.ac.za">University of Cape Town</a></p>

<h3>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Features</h3>

<ul>
<li>Implemented using an STM32F0 ARM MCU</li>
<li>Independently control the charging and discharging of up to 5 VRLA batteries</li>
<li>Inject a small ripple voltage during charging or discharging (Electrochemical Impedance Spectroscopy, used to determine the impedance)</li>
<li>Reverse polarity protection on the power terminals (not on the batteries)</li>
<li>Control features implemented on the STM32, efficiency measurements with ATMEGA2560 (using Arduino libraries).</li>
</ul>

<h3>
<a id="functions" class="anchor" href="#functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Functions</h3>

<p>A smaller-grain look at what's needed to build the high-level features:</p>

<ul>
<li>Modulate PWM signal to generate ripple voltage

<ul>
<li>DC converter is bidirectional with 2 FETs. During charging top fet controls buck converter, bottom fet is off. During discharge, bottom fet controls output, top fet is off.</li>
</ul>
</li>
<li>CC/CV charging control

<ul>
<li>Constant current until ~14V (what is full charge)?</li>
<li>Constant voltage until current reaches 0.01C</li>
<li>Rest (1hr?)</li>
</ul>
</li>
<li>Programmable electronic load:

<ul>
<li>PWM controlled FET with heat sink</li>
<li>CC discharge until 10.5V</li>
</ul>
</li>
<li>Current measurement:

<ul>
<li>Charging / discharging: measured at the specialized sensor to get I @ battery side of DC converter</li>
<li>Power / load side: measured at the opposite side of converter to get efficiency</li>
</ul>
</li>
<li>Voltage measurement: taken at the specialized sensor to get V @ battery side of DC converter</li>
</ul>

<h3>
<a id="pin-requirements" class="anchor" href="#pin-requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pin Requirements</h3>

<p><strong>STM32 (Converter Control)</strong></p>

<table>
<thead>
<tr>
<th>Function</th>
<th>Pin Type</th>
<th>Quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ibat</td>
<td>ADC</td>
<td>5</td>
</tr>
<tr>
<td>Vbat</td>
<td>ADC</td>
<td>5</td>
</tr>
<tr>
<td>PWM (charging)</td>
<td>PWM</td>
<td>10</td>
</tr>
<tr>
<td>PWM (discharging)</td>
<td>PWM</td>
<td>5</td>
</tr>
<tr>
<td>Discharge light</td>
<td>GPIO</td>
<td>5</td>
</tr>
</tbody>
</table>

<p><strong>ATMEGA2560 (DC/DC Eff. Data)</strong></p>

<table>
<thead>
<tr>
<th>Function</th>
<th>Pin Type</th>
<th>Quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ic</td>
<td>ADC</td>
<td>5</td>
</tr>
<tr>
<td>Vc</td>
<td>ADC</td>
<td>5</td>
</tr>
</tbody>
</table>

<p><strong>TI F2833</strong> (Data collection)</p>

<table>
<thead>
<tr>
<th>Function</th>
<th>Pin Type</th>
<th>Quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ibat</td>
<td>ADC</td>
<td>5</td>
</tr>
<tr>
<td>Vbat</td>
<td>ADC</td>
<td>5</td>
</tr>
<tr>
<td>Veis</td>
<td>ADC</td>
<td>5</td>
</tr>
<tr>
<td>Tbat</td>
<td>ADC</td>
<td>5</td>
</tr>
</tbody>
</table>

<h3>
<a id="project-notes" class="anchor" href="#project-notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Project Notes</h3>

<p>This is a general list of notes of important tips I've learned along the way.</p>

<p><strong>PWM using DMA</strong> - This is useful to rapidly change the PWM duty cycle without accessing the CPU. Some important tips when using CubeMX to generate the setup code:</p>

<div class="highlight highlight-source-c"><pre>    hdma_tim1_ch1.Instance = DMA1_Channel2;
    hdma_tim1_ch1.Init.Direction = DMA_MEMORY_TO_PERIPH;
    hdma_tim1_ch1.Init.PeriphInc = DMA_PINC_DISABLE;
    hdma_tim1_ch1.Init.MemInc = DMA_MINC_ENABLE;
    hdma_tim1_ch1.Init.PeriphDataAlignment = DMA_PDATAALIGN_WORD;
    hdma_tim1_ch1.Init.MemDataAlignment = DMA_MDATAALIGN_WORD;
    hdma_tim1_ch1.Init.Mode = DMA_CIRCULAR;
    hdma_tim1_ch1.Init.Priority = DMA_PRIORITY_HIGH;
    <span class="pl-en">HAL_DMA_Init</span>(&amp;hdma_tim1_ch1);</pre></div>

<p>I couldn't get this to work until I set MemInc to enable and alignment to word (defaulted to byte). To start the PWM use:</p>

<div class="highlight highlight-source-c"><pre>    <span class="pl-c1">uint32_t</span> duty_cycle[i] = {x, y, ..., i};  <span class="pl-c">// Value from 0-2^16. Must be less than period</span>
    <span class="pl-en">HAL_TIM_PWM_Start_DMA</span>(&amp;htim1, TIM_CHANNEL_1, duty_cycle, i);</pre></div>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/awdensmore/dc-conv-ctrl">Dc-conv-ctrl</a> is maintained by <a href="https://github.com/awdensmore">awdensmore</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
